<!DOCTYPE html>
<html>
<head>
  <title>Agent Inbox</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; display: flex; height: 100vh; margin: 0; }
    #sidebar { width: 250px; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    #input { display: flex; border-top: 1px solid #ccc; }
    #input input { flex: 1; padding: 10px; border: none; }
    #input button { padding: 10px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Conversations</h3>
    <ul id="convoList"></ul>
  </div>
  <div id="chat">
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="msgInput" placeholder="Type message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Notification sound -->
  <audio id="notifySound" src="/notify.mp3" preload="auto"></audio>

  <script>
    const socket = io();
    let currentConvoId = null;

    // Load conversations on sidebar
    fetch("/conversations")
      .then(res => res.json())
      .then(convos => {
        const list = document.getElementById("convoList");
        convos.forEach(c => {
          const li = document.createElement("li");
          li.textContent = `Conversation ${c.id}`;
          li.onclick = () => loadHistory(c.id);
          list.appendChild(li);
        });
      });

    function loadHistory(convoId) {
      currentConvoId = convoId;
      fetch(`/conversations/${convoId}/history`)
        .then(res => res.json())
        .then(msgs => {
          const msgDiv = document.getElementById("messages");
          msgDiv.innerHTML = "";
          msgs.forEach(m => {
            const p = document.createElement("p");
            p.textContent = `[${m.senderRole}] ${m.text}`;
            msgDiv.appendChild(p);
          });
        });
    }

    function sendMessage() {
      const input = document.getElementById("msgInput");
      if (!input.value || !currentConvoId) return;
      socket.emit("sendMessage", {
        conversationId: currentConvoId,
        text: input.value,
        senderRole: "agent"
      });
      input.value = "";
    }

    // Listen for new messages
    socket.on("newMessage", (msg) => {
      if (msg.conversationId === currentConvoId) {
        const p = document.createElement("p");
        p.textContent = `[${msg.senderRole}] ${msg.text}`;
        document.getElementById("messages").appendChild(p);
      }

      // Play sound if message came from customer
      if (msg.senderRole === "customer") {
        document.getElementById("notifySound").play();
      }
    });
  </script>
</body>
</html>

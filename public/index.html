<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>LiveChat Test</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  </head>
  <body>
    <div id="chat-section">
      <h2>LiveChat Test</h2>
      <div>
        <label>
          Role:
          <select id="role">
            <option value="customer">Customer</option>
            <option value="agent">Agent</option>
          </select>
        </label>
        <input type="text" id="token" placeholder="JWT (for agent only)" />
        <button onclick="connect()">Connect</button>
      </div>
      <div id="roomInfo"></div>
      <div id="chat"></div>
      <div>
        <input id="msg" placeholder="Type message..." />
        <button id="send">Send</button>
      </div>
    </div>

    <div id="users">
      <h3>Users</h3>
      <ul id="userList"></ul>
    </div>

    <script>
      let socket;

      function connect() {
        const role = document.getElementById("role").value;
        const token = document.getElementById("token").value;

        if (role === "agent") {
          socket = io("http://localhost:3000", {
            auth: { token }, // Agent must provide JWT
          });
        } else {
          const guestId = "guest_" + Math.floor(Math.random() * 10000);
          socket = io("http://localhost:3000", {
            query: { role, id: guestId }, // Customer fallback
          });
        }

        socket.on("connect", () => {
          document.getElementById(
            "roomInfo"
          ).innerText = `Connected as ${role}`;
        });

        socket.on("message:new", (msg) => {
          const chat = document.getElementById("chat");
          const p = document.createElement("p");
          p.innerText = `${msg.from}: ${msg.text}`;
          chat.appendChild(p);
          chat.scrollTop = chat.scrollHeight;
        });

        socket.on("presence:update", (user) => {
          const list = document.getElementById("userList");
          let li = document.getElementById("user-" + user.userId);
          if (!li) {
            li = document.createElement("li");
            li.id = "user-" + user.userId;
            list.appendChild(li);
          }
          li.className = user.online ? "online" : "offline";
          li.innerText = `${user.userId} (${
            user.online ? "online" : "offline"
          })`;
        });

        document.getElementById("send").onclick = () => {
          const msg = document.getElementById("msg").value;
          socket.emit("message:send", { text: msg });
          document.getElementById("msg").value = "";
        };
      }
    </script>
  </body>
</html>
